{
    "content": "\"\"\"DNA cleanup and quantification prep.\"\"\"\nfrom opentrons import protocol_api\nimport math\n\n# Post PCR bead cleanup and then preparation for Qubit HS DNA quantification\nmetadata = {\n    'protocolName': '466f93-4 - Automated LifeCell_NIPT_35Plex_HV',\n    'author': 'Eskil Andersen <eskil.andersen@opentrons.com>',\n    'source': 'Custom Protocol Request',\n    'apiLevel': '2.11'   # CHECK IF YOUR API LEVEL HERE IS UP TO DATE\n                         # IN SECTION 5.2 OF THE APIV2 \"VERSIONING\"\n}\n\n\ndef run(ctx: protocol_api.ProtocolContext):\n    \"\"\"Protocol entry point.\"\"\"\n    [\n     num_samples,\n     mag_engage_time_less50uL,\n     mag_engage_time_more50uL\n    ] = get_values(  # noqa: F821 (<--- DO NOT REMOVE!)\n        \"num_samples\",\n        \"mag_engage_time_less50uL\",\n        \"mag_engage_time_more50uL\")\n    # define all custom variables above here with descriptions:\n    # Bead starting well: Since some of the bead wells have been used\n    # in step 3 of the protocols we need to calculate which bead well to start\n    # from\n    bead_vol_per_sample_part3 = 25  # 25 \u00b5L per sample in step 3\n    bead_vol_per_sample = 25  # Bead solution volume for this protocol\n    bead_source_well_volume = 127\n    n_bead_mixes = 25  # Number of times to mix each bead well before use\n    bead_starting_well_offset = 1 + \\\n        math.ceil(\n            num_samples*bead_vol_per_sample_part3/bead_source_well_volume)\n    # Starting well to aspirate SPRI beads from on the bead plate\n    bead_start_well = bead_starting_well_offset\n\n    # Volume of PCR amplified DNA to transfer to the mag plate for cleanup\n    PCR_amp_DNA_sample_vol = 25\n\n    supernatant_removal_volume = 50\n    ethanol_wash_vol = 75  # 2x75 \u00b5L washes with 80 % ethanol\n    water_resuspension_vol = 22  # H2O vol to resusd. after EtOH washx2\n\n    DNA_supernatant_transfer_vol = 20  # volume of cleaned DNA for PCR plate\n    qubit_ws_vol_per_sample = 198  # QWS per DNA sample to be quant.\n    qubit_working_sol_vol = num_samples*qubit_ws_vol_per_sample\n\n    qubit_assay_dna_vol = 2  # volume of DNA to mix w/ QWS\n\n    # load modules\n    mag_mod = ctx.load_module('magnetic module gen2', '3')\n\n    '''\n\n    Add your modules here with:\n\n    module_name = ctx.load_module('{module_loadname}', '{slot number}')\n\n    Note: if you are loading a thermocycler, you do not need to specify\n    a slot number - thermocyclers will always occupy slots 7, 8, 10, and 11.\n\n    For all other modules, you can load them on slots 1, 3, 4, 6, 7, 9, 10.\n\n    '''\n\n    # load labware\n    mag_bead_cleanup_plate \\\n        = mag_mod.load_labware('biorad_96_wellplate_200ul_pcr',\n                               'Magnetic module sample plate')\n    SPRI_bead_plate \\\n        = ctx.load_labware('biorad_96_wellplate_200ul_pcr', '9',\n                           'Magnetic bead plate')\n    reservoir \\\n        = ctx.load_labware('nest_12_reservoir_15ml', '6',\n                           'Reagent reservoir')\n    quantification_destination_plate \\\n        = ctx.load_labware('biorad_96_wellplate_200ul_pcr', '1',\n                           'quantification plate')\n    PCR_amplified_sample_plate \\\n        = ctx.load_labware('biorad_96_wellplate_200ul_pcr', '2',\n                           'sample plate')\n\n    '''\n\n    Add your labware here with:\n\n    labware_name = ctx.load_labware('{loadname}', '{slot number}')\n\n    If loading labware on a module, you can load with:\n\n    labware_name = module_name.load_labware('{loadname}')\n    where module_name is defined above.\n\n    '''\n\n    # load tipracks\n\n    '''\n\n    Add your tipracks here as a list:\n\n    For a single tip rack:\n\n    tiprack_name = [ctx.load_labware('{loadname}', '{slot number}')]\n\n    For multiple tip racks of the same type:\n\n    tiprack_name = [ctx.load_labware('{loadname}', 'slot')\n                     for slot in ['1', '2', '3']]\n\n    If two different tipracks are on the deck, use convention:\n    tiprack[number of microliters]\n    e.g. tiprack10, tiprack20, tiprack200, tiprack300, tiprack1000\n\n    '''\n    tiprack20s = [ctx.load_labware('opentrons_96_filtertiprack_20ul', slot)\n                  for slot in ['10', '11']]\n    tiprack200s = [ctx.load_labware('opentrons_96_filtertiprack_200ul', slot)\n                   for slot in ['5', '8']]\n\n    # load instrument\n\n    '''\n    Nomenclature for pipette:\n\n    use 'p'  for single-channel, 'm' for multi-channel,\n    followed by number of microliters.\n\n    p20, p300, p1000 (single channel pipettes)\n    m20, m300 (multi-channel pipettes)\n\n    If loading pipette, load with:\n\n    ctx.load_instrument(\n                        '{pipette api load name}',\n                        pipette_mount (\"left\", or \"right\"),\n                        tip_racks=tiprack\n                        )\n    '''\n    p20 = ctx.load_instrument(\"p20_single_gen2\", \"left\", tip_racks=tiprack20s)\n    p300 = ctx.load_instrument(\"p300_single_gen2\", \"right\",\n                               tip_racks=tiprack200s)\n\n    # pipette functions   # INCLUDE ANY BINDING TO CLASS\n\n    '''\n\n    Define all pipette functions, and class extensions here.\n    These may include but are not limited to:\n\n    - Custom pickup functions\n    - Custom drop tip functions\n    - Custom Tip tracking functions\n    - Custom Trash tracking functions\n    - Slow tip withdrawal\n\n    For any functions in your protocol, describe the function as well as\n    describe the parameters which are to be passed in as a docstring below\n    the function (see below).\n\n    def pick_up(pipette):\n        \"\"\"`pick_up()` will pause the protocol when all tip boxes are out of\n        tips, prompting the user to replace all tip racks. Once tipracks are\n        reset, the protocol will start picking up tips from the first tip\n        box as defined in the slot order when assigning the labware definition\n        for that tip box. `pick_up()` will track tips for both pipettes if\n        applicable.\n\n        :param pipette: The pipette desired to pick up tip\n        as definited earlier in the protocol (e.g. p300, m20).\n        \"\"\"\n        try:\n            pipette.pick_up_tip()\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Replace empty tip racks\")\n            pipette.reset_tipracks()\n            pipette.pick_up_tip()\n\n    '''\n\n    # helper functions\n    '''\n    Define any custom helper functions outside of the pipette scope here, using\n    the convention seen above.\n\n    e.g.\n\n    def remove_supernatant(vol, index):\n        \"\"\"\n        function description\n\n        :param vol:\n\n        :param index:\n        \"\"\"\n\n\n    '''\n    # Volume Tracking\n    class VolTracker:\n        def __init__(self, labware, well_vol,\n                     start=0, end=8,\n                     mode='reagent', pip_type='single',\n                     msg='Reset labware volumes'):\n            \"\"\"Voltracker tracks the volume(s) used in a piece of labware.\n\n            Args:\n                labware: The labware to track\n                well_vol: The volume of the liquid in the wells\n                pip_type: The pipette type used 'single' or 'multi'\n                mode: 'reagent' or 'waste'\n                start: The starting well\n                end: The ending well\n                msg: Message to send to the user when all wells are empty\n\n            \"\"\"\n            self.labware_wells = dict.fromkeys(\n                labware.wells()[start:end], 0)\n            self.labware_wells_backup = self.labware_wells.copy()\n            self.well_vol = well_vol\n            self.pip_type = pip_type\n            self.mode = mode\n            self.start = start\n            self.end = end\n            self.msg = msg\n\n        def tracker(self, vol):\n            \"\"\"\n            Tracker function: Track well volume and switch when too low to use.\n\n            Tracker() will track how much liquid\n            was used up per well. If the volume of\n            a given well is greater than self.well_vol\n            it will remove it from the dictionary and iterate\n            to the next well which will act as the reservoir.\n            \"\"\"\n            well = next(iter(self.labware_wells))\n            new_well = False\n            if self.labware_wells[well] + vol >= self.well_vol:\n                del self.labware_wells[well]\n                if len(self.labware_wells) < 1:\n                    ctx.pause(self.msg)\n                    self.labware_wells = self.labware_wells_backup.copy()\n                well = next(iter(self.labware_wells))\n                new_well = True\n            if self.pip_type == 'multi':\n                self.labware_wells[well] = self.labware_wells[well] + vol*8\n            elif self.pip_type == 'single':\n                self.labware_wells[well] = self.labware_wells[well] + vol\n            if self.mode == 'waste':\n                ctx.comment(f'''{well}: {int(self.labware_wells[well])} uL of\n                            total waste''')\n            else:\n                ctx.comment(f'''{int(self.labware_wells[well])} uL of liquid\n                            used from {well}''')\n            return well, new_well\n\n    # reagents\n\n    '''\n    Define where all reagents are on the deck using the labware defined above.\n\n    e.g.\n\n    water = reservoir12.wells()[-1]\n    waste = reservoir.wells()[0]\n    samples = plate.rows()[0][0]\n    dnase = tuberack.wells_by_name()['A4']\n\n    '''\n    ethanol = reservoir.wells_by_name()['A1']\n    water_well = reservoir.wells_by_name()['A2']\n    waste_well = reservoir.wells()[-1]\n    qubit_ws_tracker = VolTracker(reservoir, qubit_working_sol_vol, 2, 3)\n\n    bead_well_tracker = VolTracker(SPRI_bead_plate, bead_source_well_volume,\n                                   bead_start_well, 96)\n\n    mag_plate_sample_wells = mag_bead_cleanup_plate.wells()[0:num_samples]\n    PCR_amp_sample_wells = PCR_amplified_sample_plate.wells()[0:num_samples]\n    quant_DNA_sample_wells = \\\n        quantification_destination_plate.wells()[0:num_samples]\n\n    # Use the wells starting at column 6 to the end for mixing DNA\n    # With Qubit HS working solution (8*5+1=41 [=40 with 0-inclusive index])\n    qubit_quant_wells = \\\n        quantification_destination_plate.wells()[40:40+num_samples]\n    # plate, tube rack maps\n\n    '''\n    Define any plate or tube maps here.\n\n    e.g.\n\n    plate_wells_by_row = [well for row in plate.rows() for well in row]\n\n    '''\n\n    # protocol\n\n    '''\n\n    Include header sections as follows for each \"section\" of your protocol.\n\n    Section can be defined as a step in a bench protocol.\n\n    e.g.\n\n    ctx.comment('\\n\\nMOVING MASTERMIX TO SAMPLES IN COLUMNS 1-6\\n')\n\n    for .... in ...:\n        ...\n        ...\n\n    ctx.comment('\\n\\nRUNNING THERMOCYCLER PROFILE\\n')\n\n    ...\n    ...\n    ...\n\n\n    '''\n    ctx.comment(\"\\n\\nTransferring PCR amplified DNA to magnetic cleanup plate\")\n    for s_well, d_well in zip(PCR_amp_sample_wells,\n                              mag_plate_sample_wells):\n        try:\n            p300.transfer(PCR_amp_DNA_sample_vol, s_well, d_well)\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Please replace empty 200 uL tipracks\")\n            p300.transfer(PCR_amp_DNA_sample_vol, s_well, d_well)\n\n    ctx.comment(\"\\n\\nMixing and transferring beads to the samples\")\n\n    bead_well, _ = bead_well_tracker.tracker(bead_vol_per_sample)\n    try:\n        p300.pick_up_tip()\n    except protocol_api.labware.OutOfTipsError:\n        ctx.pause(\"Please replace empty 200 uL tipracks\")\n        p300.pick_up_tip()\n    p300.mix(n_bead_mixes, bead_source_well_volume/2, bead_well)\n\n    for d_well in mag_plate_sample_wells:\n        bead_well, is_new_well = bead_well_tracker.tracker(bead_vol_per_sample)\n        if is_new_well:\n            if not p300.has_tip:\n                try:\n                    p300.pick_up_tip()\n                except protocol_api.labware.OutOfTipsError:\n                    ctx.pause(\"Please replace empty 200 uL tipracks\")\n                    p300.pick_up_tip()\n            p300.mix(n_bead_mixes, bead_source_well_volume/2, bead_well)\n        try:\n            if not p300.has_tip:\n                p300.pick_up_tip()\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Please replace empty 200 uL tipracks\")\n            if not p300.has_tip:\n                p300.pick_up_tip()\n        p300.aspirate(bead_vol_per_sample, bead_well)\n        p300.dispense(bead_vol_per_sample, d_well)\n        p300.drop_tip()\n\n    ctx.comment(\"\\n\\nIncubating samples\")\n    ctx.delay(0, 5)\n    ctx.pause(\"\\n\\nPulse spin bead/sample plate for 5s before continuing\")\n\n    ctx.comment(\"\\n\\nEngaging magnets for {} minutes\".\n                format(mag_engage_time_less50uL))\n    mag_mod.engage()\n    ctx.delay(0, mag_engage_time_less50uL)\n\n    ctx.comment(\"\\n\\nRemoving supernatant\\n\")\n    for dest_well in mag_plate_sample_wells:\n        try:\n            p300.transfer(supernatant_removal_volume, dest_well, waste_well)\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Please replace empty 200 uL tipracks\")\n            p300.transfer(supernatant_removal_volume, dest_well, waste_well)\n\n    ctx.comment(\"\\n\\nWashing beads with 80% ethanol\")\n    # Wash beads in 80 % ethanol x 2\n    for i in range(0, 2):\n        for dest_well in mag_plate_sample_wells:\n            try:\n                p300.transfer(ethanol_wash_vol, ethanol, dest_well)\n            except protocol_api.labware.OutOfTipsError:\n                ctx.pause(\"Please replace 200 uL tipracks before continuing\\n\")\n                p300.reset_tipracks()\n                p300.transfer(ethanol_wash_vol, ethanol, dest_well)\n\n        ctx.delay(30, 0, \"\\n\\nIncubation #{} in 80% EtOH\\n\".format(i+1))\n        for source_well in mag_plate_sample_wells:\n            try:\n                p300.transfer(ethanol_wash_vol, source_well, waste_well)\n            except protocol_api.labware.OutOfTipsError:\n                ctx.pause(\"Please replace 200 uL tipracks before continuing\\n\")\n                p300.reset_tipracks()\n                p300.transfer(ethanol_wash_vol, source_well, waste_well)\n\n    mag_mod.disengage()\n    ctx.pause(\"\\n\\nPulse spin the sample plate on the magnetic module for \" +\n              \"5 seconds, then place it back on the magnetic module\")\n    mag_mod.engage()\n    ctx.delay(0, mag_engage_time_less50uL, \"Binding the beads to the magnets\")\n    ctx.comment(\"\\n\\nRemoving remaining wash supernatant from the wells\\n\")\n    for dest_well in mag_plate_sample_wells:\n        try:\n            p20.transfer(20, dest_well, waste_well)\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Please replace empty 200 uL tipracks\")\n            p20.transfer(20, dest_well, waste_well)\n\n    ctx.delay(0, 5, \"Drying the beads\")\n\n    # Resuspend, mix and incubate beads in water\n    for well in mag_plate_sample_wells:\n        pip = p20 if water_resuspension_vol <= 20 else p300\n        try:\n            pip.pick_up_tip()\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Please replace empty tipracks before continuing\\n\")\n            pip.reset_tipracks()\n            pip.pick_up_tip()\n        pip.aspirate(water_resuspension_vol, water_well)\n        pip.dispense(water_resuspension_vol, well)\n        pip.mix(5, 10, well)\n        pip.drop_tip()\n\n    ctx.comment(\"Incubating beads in water\")\n    ctx.delay(0, 3)\n    ctx.pause(\"Pulse spin the sample/bead plate for 5 seconds, then place \" +\n              \"it back on the magnetic module\")\n    ctx.comment(\"Attracting beads\")\n    ctx.delay(0, mag_engage_time_less50uL)\n    ctx.comment(\"\\n\\nTransferring DNA containing supernatant to quant. plate\")\n\n    # Transfer DNA containing bead well supernatant to quantification plate\n    pip = p20 if DNA_supernatant_transfer_vol <= 20 else p300\n    for s_well, d_well in zip(mag_plate_sample_wells,\n                              quant_DNA_sample_wells):\n        try:\n            pip.transfer(DNA_supernatant_transfer_vol, s_well, d_well)\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Please replace empty tipracks before continuing\\n\")\n            pip.reset_tipracks()\n            pip.transfer(DNA_supernatant_transfer_vol, s_well, d_well)\n\n    # Prepare quant. samples for quantification with Qubit HS kit\n    qubit_ws_well, _ = qubit_ws_tracker.tracker(0)\n\n    try:\n        p300.pick_up_tip()\n    except protocol_api.labware.OutOfTipsError:\n        ctx.pause(\"Please replace empty tipracks before continuing\\n\")\n        p300.reset_tipracks()\n        p300.pick_up_tip()\n    p300.mix(10, 200, qubit_ws_well)\n\n    # Mix quant. samples with Qubit working solution\n    # First, distribute the QWS\n    for d_well in qubit_quant_wells:\n        p300.transfer(qubit_ws_vol_per_sample, qubit_ws_well, d_well,\n                      new_tip='never')\n    p300.drop_tip()\n\n    # Transfer DNA to quant wells.\n    for s_well, d_well in zip(quant_DNA_sample_wells, qubit_quant_wells):\n        p20.transfer(qubit_assay_dna_vol, s_well, d_well)\n\n    ctx.comment(\"\\n\\nVortex plate for 2-3 seconds and incubate at RT \" +\n                \"for 2 minutes before continuing\")\n    ctx.comment(\"\\n\\n~~~ End of protocol part 4 ~~~\")\n",
    "custom_labware_defs": [],
    "fields": [
        {
            "default": 36,
            "label": "Number of samples",
            "name": "num_samples",
            "type": "int"
        },
        {
            "default": 5,
            "label": "Magnetic engagement time when total sample volume < 50 uL",
            "name": "mag_engage_time_less50uL",
            "type": "int"
        },
        {
            "default": 7,
            "label": "Magnetic engagement time when total sample volume > 50 uL",
            "name": "mag_engage_time_more50uL",
            "type": "int"
        }
    ],
    "instruments": [
        {
            "mount": "left",
            "name": "p20_single_gen2"
        },
        {
            "mount": "right",
            "name": "p300_single_gen2"
        }
    ],
    "labware": [
        {
            "name": "quantification plate on 1",
            "share": false,
            "slot": "1",
            "type": "biorad_96_wellplate_200ul_pcr"
        },
        {
            "name": "sample plate on 2",
            "share": false,
            "slot": "2",
            "type": "biorad_96_wellplate_200ul_pcr"
        },
        {
            "name": "Magnetic module sample plate on Magnetic Module GEN2 on 3",
            "share": false,
            "slot": "3",
            "type": "biorad_96_wellplate_200ul_pcr"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 200 \u00b5L on 5",
            "share": false,
            "slot": "5",
            "type": "opentrons_96_filtertiprack_200ul"
        },
        {
            "name": "Reagent reservoir on 6",
            "share": false,
            "slot": "6",
            "type": "nest_12_reservoir_15ml"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 200 \u00b5L on 8",
            "share": false,
            "slot": "8",
            "type": "opentrons_96_filtertiprack_200ul"
        },
        {
            "name": "Magnetic bead plate on 9",
            "share": false,
            "slot": "9",
            "type": "biorad_96_wellplate_200ul_pcr"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 20 \u00b5L on 10",
            "share": false,
            "slot": "10",
            "type": "opentrons_96_filtertiprack_20ul"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 20 \u00b5L on 11",
            "share": false,
            "slot": "11",
            "type": "opentrons_96_filtertiprack_20ul"
        },
        {
            "name": "Opentrons Fixed Trash on 12",
            "share": false,
            "slot": "12",
            "type": "opentrons_1_trash_1100ml_fixed"
        }
    ],
    "metadata": {
        "apiLevel": "2.11",
        "author": "Eskil Andersen <eskil.andersen@opentrons.com>",
        "protocolName": "466f93-4 - Automated LifeCell_NIPT_35Plex_HV",
        "source": "Custom Protocol Request"
    },
    "modules": []
}