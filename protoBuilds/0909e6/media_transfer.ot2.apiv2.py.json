{
    "content": "from io import StringIO\nimport csv\nimport math\nfrom opentrons.protocol_api.labware import Well\n\nmetadata = {\n    'protocolName': 'Cell Culture',\n    'author': 'Nick <ndiehl@opentrons.com',\n    'source': 'Custom Protocol Request',\n    'apiLevel': '2.12'\n}\n\n\ndef run(ctx):\n\n    [csv_factors] = get_values(  # noqa: F821\n        'csv_factors')\n\n    class WellH(Well):\n        def __init__(self, well, height=5, min_height=3,\n                     comp_coeff=1.15, current_volume=0, min_vol=1000):\n            super().__init__(well._impl)\n            self.well = well\n            self.height = height\n            self.min_height = min_height\n            self.comp_coeff = comp_coeff\n            self.radius = self.diameter/2\n            self.current_volume = current_volume\n            self.min_vol = min_vol\n\n        def height_dec(self, vol):\n            dh = (vol/(math.pi*(self.radius**2)))*self.comp_coeff\n            if self.height - dh > self.min_height:\n                self.height = self.height - dh\n            else:\n                self.height = self.min_height\n            if self.current_volume - vol > 0:\n                self.current_volume = self.current_volume - vol\n            else:\n                self.current_volume = 0\n            return(self.well.bottom(self.height))\n\n        def height_inc(self, vol):\n            dh = (vol/(math.pi*(self.radius**2)))*self.comp_coeff\n            if self.height + dh < self.depth:\n                self.height = self.height + dh\n            else:\n                self.height = self.depth\n            self.current_volume += vol\n            return(self.well.bottom(self.height + 20))\n\n    # labware\n    tuberack50 = ctx.load_labware('opentrons_6_tuberack_falcon_50ml_conical',\n                                  '1', 'media tuberack')\n    tuberack15 = ctx.load_labware('opentrons_15_tuberack_falcon_15ml_conical',\n                                  '4', 'factor tuberack')\n    plate = ctx.load_labware('usascientific_96_wellplate_2.4ml_deep', '2')\n    tiprack300 = [ctx.load_labware('opentrons_96_filtertiprack_200ul', '3')]\n    tiprack1000 = [ctx.load_labware('opentrons_96_filtertiprack_1000ul', '6')]\n\n    # pipettes\n    p300 = ctx.load_instrument('p300_single_gen2', 'left',\n                               tip_racks=tiprack300)\n    p1000 = ctx.load_instrument('p1000_single_gen2', 'right',\n                                tip_racks=tiprack1000)\n\n    # reagents\n    media = [\n        WellH(well, current_volume=48000, height=well.depth*0.9)\n        for well in tuberack50.rows()[0]]\n\n    # parse data\n    f = StringIO(csv_factors)\n    reader = csv.reader(f, delimiter=',')\n    data = []\n    for i, row in enumerate(reader):\n        if i > 1:\n            content = [float(val) for val in row[2:] if val]\n            data.append(content)\n    num_factors = len(data[0]) - 3  # exclude total volume, media volume\n    factors = tuberack15.wells()[:num_factors]\n\n    def slow_withdraw(well, pip=p1000):\n        ctx.max_speeds['A'] = 25\n        ctx.max_speeds['Z'] = 25\n        pip.move_to(well.top())\n        del ctx.max_speeds['A']\n        del ctx.max_speeds['Z']\n\n    def split_media_vol(vol):\n        num_transfers = math.ceil(vol/1000)\n        vol_per_transfer = round(vol/num_transfers, 1)\n        return [vol_per_transfer]*num_transfers\n\n    # iterate\n    iterator_media = iter(media)\n    current_media = next(iterator_media)\n\n    def check_media(vol):\n        nonlocal current_media\n        if current_media.current_volume - vol < current_media.min_vol:\n            current_media = next(iterator_media)\n\n    # transfer media\n    p1000.pick_up_tip()\n    for well, line in zip(plate.wells(), data):\n        vol_media_total = line[0]\n        vol_media_split = split_media_vol(vol_media_total)\n        for vol in vol_media_split:\n            check_media(vol)\n            p1000.aspirate(vol, current_media.height_dec(vol))\n            slow_withdraw(current_media, p1000)\n            p1000.dispense(vol, well.bottom(2))\n            slow_withdraw(well, p1000)\n\n    # transfer factors\n    for i, factor in enumerate(factors):\n        p300.pick_up_tip()\n        for well, line in zip(plate.wells(), data):\n            factor_vol = line[3+i]\n            if factor_vol > 0:\n                p300.aspirate(factor_vol, factor.bottom(1.5))\n                slow_withdraw(factor, p300)\n                p300.dispense(factor_vol, well.top(-2))\n        p300.drop_tip()\n\n    # mix\n    for well in plate.wells()[:len(data)]:\n        if not p1000.has_tip:\n            p1000.pick_up_tip()\n        p1000.mix(5, 800, well.bottom(2))\n        slow_withdraw(well, p1000)\n        p1000.drop_tip()\n",
    "custom_labware_defs": [],
    "fields": [
        {
            "default": "Step Order,Steps,Media Total,Media (up to 600uL),Media (rest),Factor 1,Factor 2,Factor 3,Factor 4,Factor 5,Factor 6,Factor 7,Factor 8,Factor 9,Factor 10,Factor 11,Factor 12,\n,FGF8,BGJ,BMP4/8,LDN,WNT3A,IWP2,R-Spondin,GDNF,SPP86,LARA,AGN193109,Gamma XX,\n1,\"Transfer Media into A1, then Transfer Factor 1 - 12 into A1\",1170,600,570,0,0,0,0,0,0,0,0,0,0,65,65,\n2,\"Transfer Media into A2, then Transfer Factor 1 - 12 into A2\",1235,600,635,0,65,0,0,0,0,0,0,0,0,0,0,\n3,\"Transfer Media into A3, then Transfer Factor 1 - 12 into A3\",1040,600,440,65,65,0,65,0,0,0,0,0,0,0,65,\n4,\"Transfer Media, then Transfer Factor 1 - 12 into A4\",975,600,375,0,65,65,65,65,0,0,0,0,0,0,65,\n5,\"Transfer Media, then Transfer Factor 1 - 12 into A5\",1053,600,453,0,0,65,65,0,52,0,0,0,0,65,0,\n6,\"Transfer Media, then Transfer Factor 1 - 12 into A6\",988,600,388,0,65,65,0,65,52,0,0,0,0,65,0,\n7,\"Transfer Media, then Transfer Factor 1 - 12 into A7\",845,600,245,65,65,65,65,0,0,65,0,0,0,65,65,\n8,\"Transfer Media, then Transfer Factor 1 - 12 into A8\",910,600,310,0,65,0,65,65,0,65,0,0,0,65,65,\n9,\"Transfer Media, then Transfer Factor 1 - 12 into A9\",858,600,258,65,65,65,0,65,52,65,0,0,0,0,65,\n10,\"Transfer Media, then Transfer Factor 1 - 12 into A10\",988,600,388,0,0,0,65,65,52,65,0,0,0,0,65,\n11,\"Transfer Media, then Transfer Factor 1 - 12 into A11\",1040,600,440,0,65,65,0,0,0,0,65,0,0,65,0,\n12,\"Transfer Media, then Transfer Factor 1 - 12 into A12\",1105,600,505,0,0,0,65,0,0,0,65,0,0,0,65,\n13,\"Transfer Media, then Transfer Factor 1 - 12 into B1\",1040,600,440,65,0,0,0,65,0,0,65,0,0,0,65,\n14,\"Transfer Media, then Transfer Factor 1 - 12 into B2\",923,600,323,65,0,65,0,0,52,0,65,0,0,65,65,\n15,\"Transfer Media, then Transfer Factor 1 - 12 into B3\",923,600,323,0,65,0,65,65,52,0,65,0,0,65,0,\n16,\"Transfer Media, then Transfer Factor 1 - 12 into B4\",923,600,323,65,0,65,65,65,52,0,65,0,0,0,0,\n17,\"Transfer Media, then Transfer Factor 1 - 12 into B5\",975,600,375,65,0,0,65,0,0,65,65,0,0,65,0,\n18,\"Transfer Media, then Transfer Factor 1 - 12 into B6\",1040,600,440,0,0,0,0,65,0,65,65,0,0,65,0,\n19,\"Transfer Media, then Transfer Factor 1 - 12 into B7\",910,600,310,65,65,65,0,65,0,65,65,0,0,0,0,\n20,\"Transfer Media, then Transfer Factor 1 - 12 into B8\",1053,600,453,0,0,65,0,0,52,65,65,0,0,0,0,\n21,\"Transfer Media, then Transfer Factor 1 - 12 into B9\",858,600,258,0,65,65,65,0,52,65,65,0,0,0,65,\n22,\"Transfer Media, then Transfer Factor 1 - 12 into B10\",793,600,193,65,65,0,0,65,52,65,65,0,0,65,65,\n23,\"Transfer Media, then Transfer Factor 1 - 12 into B11\",793,600,193,0,0,65,65,65,52,65,65,0,0,65,65,\n24,\"Transfer Media, then Transfer Factor 1 - 12 into B12\",975,600,375,65,65,65,0,0,0,0,0,65,0,0,65,\n25,\"Transfer Media, then Transfer Factor 1 - 12 into C1\",1040,600,440,65,0,65,65,0,0,0,0,65,0,0,0,\n26,\"Transfer Media, then Transfer Factor 1 - 12 into C2\",910,600,310,65,0,0,65,65,0,0,0,65,0,65,65,\n27,\"Transfer Media, then Transfer Factor 1 - 12 into C3\",1053,600,453,0,65,0,0,0,52,0,0,65,0,0,65,\n28,\"Transfer Media, then Transfer Factor 1 - 12 into C4\",728,600,128,65,65,65,65,65,52,0,0,65,0,65,65,\n29,\"Transfer Media, then Transfer Factor 1 - 12 into C5\",1040,600,440,0,0,0,65,0,0,65,0,65,0,0,65,\n30,\"Transfer Media, then Transfer Factor 1 - 12 into C6\",910,600,310,65,65,0,0,65,0,65,0,65,0,65,0,\n31,\"Transfer Media, then Transfer Factor 1 - 12 into C7\",1040,600,440,0,0,65,0,65,0,65,0,65,0,0,0,\n32,\"Transfer Media, then Transfer Factor 1 - 12 into C8\",858,600,258,65,0,65,0,0,52,65,0,65,0,65,65,\n33,\"Transfer Media, then Transfer Factor 1 - 12 into C9\",923,600,323,65,65,0,65,0,52,65,0,65,0,0,0,\n34,\"Transfer Media, then Transfer Factor 1 - 12 into C10\",1105,600,505,65,0,0,0,0,0,0,65,65,0,0,0,\n35,\"Transfer Media, then Transfer Factor 1 - 12 into C11\",910,600,310,65,65,0,65,65,0,0,65,65,0,0,0,\n36,\"Transfer Media, then Transfer Factor 1 - 12 into C12\",910,600,310,0,0,65,65,65,0,0,65,65,0,65,0,\n37,\"Transfer Media, then Transfer Factor 1 - 12 into D1\",923,600,323,65,65,0,0,0,52,0,65,65,0,65,0,\n38,\"Transfer Media, then Transfer Factor 1 - 12 into D2\",923,600,323,0,0,0,0,65,52,0,65,65,0,65,65,\n39,\"Transfer Media, then Transfer Factor 1 - 12 into D3\",793,600,193,65,65,65,0,65,52,0,65,65,0,0,65,\n40,\"Transfer Media, then Transfer Factor 1 - 12 into D4\",910,600,310,0,65,65,65,0,0,65,65,65,0,0,0,\n41,\"Transfer Media, then Transfer Factor 1 - 12 into D5\",780,600,180,0,65,65,0,65,0,65,65,65,0,65,65,\n42,\"Transfer Media, then Transfer Factor 1 - 12 into D6\",793,600,193,0,65,0,65,0,52,65,65,65,0,65,65,\n43,\"Transfer Media, then Transfer Factor 1 - 12 into D7\",793,600,193,65,0,65,65,0,52,65,65,65,0,0,65,\n44,\"Transfer Media, then Transfer Factor 1 - 12 into D8\",923,600,323,0,65,0,0,65,52,65,65,65,0,0,0,\n45,\"Transfer Media, then Transfer Factor 1 - 12 into D9\",793,600,193,65,0,65,0,65,52,65,65,65,0,65,0,\n46,\"Transfer Media, then Transfer Factor 1 - 12 into D10\",1118,600,518,0,0,65,0,0,0,0,0,0,52,0,65,\n47,\"Transfer Media, then Transfer Factor 1 - 12 into D11\",1118,600,518,0,0,0,65,65,0,0,0,0,52,0,0,\n48,\"Transfer Media, then Transfer Factor 1 - 12 into D12\",858,600,258,65,65,65,65,65,0,0,0,0,52,65,0,\n49,\"Transfer Media, then Transfer Factor 1 - 12 into E1\",1001,600,401,65,65,65,0,0,52,0,0,0,52,0,0,\n50,\"Transfer Media, then Transfer Factor 1 - 12 into E2\",936,600,336,0,65,0,65,0,52,0,0,0,52,65,65,\n51,\"Transfer Media, then Transfer Factor 1 - 12 into E3\",871,600,271,0,0,65,65,65,52,0,0,0,52,65,65,\n52,\"Transfer Media, then Transfer Factor 1 - 12 into E4\",988,600,388,0,65,65,0,0,0,65,0,0,52,65,0,\n53,\"Transfer Media, then Transfer Factor 1 - 12 into E5\",988,600,388,65,0,65,65,0,0,65,0,0,52,0,0,\n54,\"Transfer Media, then Transfer Factor 1 - 12 into E6\",988,600,388,0,65,0,0,65,0,65,0,0,52,0,65,\n55,\"Transfer Media, then Transfer Factor 1 - 12 into E7\",858,600,258,65,0,65,0,65,0,65,0,0,52,65,65,\n56,\"Transfer Media, then Transfer Factor 1 - 12 into E8\",871,600,271,65,0,0,65,0,52,65,0,0,52,65,65,\n57,\"Transfer Media, then Transfer Factor 1 - 12 into E9\",1001,600,401,65,0,0,0,65,52,65,0,0,52,0,0,\n58,\"Transfer Media, then Transfer Factor 1 - 12 into E10\",871,600,271,0,65,65,65,65,52,65,0,0,52,0,0,\n59,\"Transfer Media, then Transfer Factor 1 - 12 into E11\",923,600,323,65,65,0,0,0,0,0,65,0,52,65,65,\n60,\"Transfer Media, then Transfer Factor 1 - 12 into E12\",988,600,388,0,65,65,65,0,0,0,65,0,52,0,0,\n61,\"Transfer Media, then Transfer Factor 1 - 12 into F1\",1066,600,466,0,0,0,0,0,52,0,65,0,52,65,0,\n62,\"Transfer Media, then Transfer Factor 1 - 12 into F2\",806,600,206,65,65,0,65,65,52,0,65,0,52,0,65,\n63,\"Transfer Media, then Transfer Factor 1 - 12 into F3\",858,600,258,65,65,65,0,0,0,65,65,0,52,0,65,\n64,\"Transfer Media, then Transfer Factor 1 - 12 into F4\",858,600,258,0,0,65,65,0,0,65,65,0,52,65,65,\n65,\"Transfer Media, then Transfer Factor 1 - 12 into F5\",858,600,258,65,65,0,0,65,0,65,65,0,52,65,0,\n66,\"Transfer Media, then Transfer Factor 1 - 12 into F6\",793,600,193,65,0,0,65,65,0,65,65,0,52,65,65,\n67,\"Transfer Media, then Transfer Factor 1 - 12 into F7\",871,600,271,65,65,0,65,0,52,65,65,0,52,0,0,\n68,\"Transfer Media, then Transfer Factor 1 - 12 into F8\",741,600,141,65,65,65,65,0,52,65,65,0,52,65,0,\n69,\"Transfer Media, then Transfer Factor 1 - 12 into F9\",871,600,271,0,0,65,0,65,52,65,65,0,52,0,65,\n70,\"Transfer Media, then Transfer Factor 1 - 12 into F10\",988,600,388,65,0,65,0,0,0,0,0,65,52,65,0,\n71,\"Transfer Media, then Transfer Factor 1 - 12 into F11\",988,600,388,0,65,0,65,0,0,0,0,65,52,65,0,\n72,\"Transfer Media, then Transfer Factor 1 - 12 into F12\",858,600,258,0,65,65,0,65,0,0,0,65,52,65,65,\n73,\"Transfer Media, then Transfer Factor 1 - 12 into G1\",1001,600,401,65,0,0,0,0,52,0,0,65,52,0,65,\n74,\"Transfer Media, then Transfer Factor 1 - 12 into G2\",806,600,206,65,65,0,0,65,52,0,0,65,52,65,65,\n75,\"Transfer Media, then Transfer Factor 1 - 12 into G3\",871,600,271,65,0,65,65,65,52,0,0,65,52,0,0,\n76,\"Transfer Media, then Transfer Factor 1 - 12 into G4\",858,600,258,65,65,0,65,65,0,65,0,65,52,0,0,\n77,\"Transfer Media, then Transfer Factor 1 - 12 into G5\",858,600,258,0,0,65,65,65,0,65,0,65,52,65,0,\n78,\"Transfer Media, then Transfer Factor 1 - 12 into G6\",1001,600,401,0,0,0,0,0,52,65,0,65,52,65,0,\n79,\"Transfer Media, then Transfer Factor 1 - 12 into G7\",806,600,206,0,65,65,65,0,52,65,0,65,52,0,65,\n80,\"Transfer Media, then Transfer Factor 1 - 12 into G8\",871,600,271,0,0,0,0,65,52,65,0,65,52,65,65,\n81,\"Transfer Media, then Transfer Factor 1 - 12 into G9\",988,600,388,0,0,65,0,0,0,0,65,65,52,0,65,\n82,\"Transfer Media, then Transfer Factor 1 - 12 into G10\",858,600,258,65,65,65,0,65,0,0,65,65,52,0,0,\n83,\"Transfer Media, then Transfer Factor 1 - 12 into G11\",793,600,193,0,65,0,65,65,0,0,65,65,52,65,65,\n84,\"Transfer Media, then Transfer Factor 1 - 12 into G12\",793,600,193,65,0,65,65,65,0,0,65,65,52,0,65,\n85,\"Transfer Media, then Transfer Factor 1 - 12 into H1\",806,600,206,0,65,65,0,0,52,0,65,65,52,65,65,\n86,\"Transfer Media, then Transfer Factor 1 - 12 into H2\",806,600,206,65,0,0,65,65,52,0,65,65,52,65,0,\n87,\"Transfer Media, then Transfer Factor 1 - 12 into H3\",806,600,206,0,65,65,65,65,52,0,65,65,52,0,0,\n88,\"Transfer Media, then Transfer Factor 1 - 12 into H4\",663,600,63,65,65,65,65,0,0,65,65,65,52,65,65,\n89,\"Transfer Media, then Transfer Factor 1 - 12 into H5\",858,600,258,65,0,0,0,65,0,65,65,65,52,0,65,\n90,\"Transfer Media, then Transfer Factor 1 - 12 into H6\",728,600,128,0,65,65,65,65,0,65,65,65,52,0,65,\n91,\"Transfer Media, then Transfer Factor 1 - 12 into H7\",871,600,271,0,65,0,0,0,52,65,65,65,52,0,65,\n92,\"Transfer Media, then Transfer Factor 1 - 12 into H8\",936,600,336,0,0,0,65,0,52,65,65,65,52,0,0,\n93,\"Transfer Media, then Transfer Factor 1 - 12 into H9\",923,600,323,32.5,32.5,32.5,32.5,32.5,26,32.5,32.5,32.5,26,32.5,32.5,\n94,\"Transfer Media, then Transfer Factor 1 - 12 into H10\",923,600,323,32.5,32.5,32.5,32.5,32.5,26,32.5,32.5,32.5,26,32.5,32.5,\n95,\"Transfer Media, then Transfer Factor 1 - 12 into H11\",1300,600,700,0,0,0,0,0,0,0,0,0,0,0,0,\n96,\"Transfer Media, then Transfer Factor 1 - 12 into H12\",1300,600,700,0,0,0,0,0,0,0,0,0,0,0,0,\n97-192,Mix well 1-96",
            "label": "factor .csv file",
            "name": "csv_factors",
            "type": "textFile"
        }
    ],
    "instruments": [
        {
            "mount": "left",
            "name": "p300_single_gen2"
        },
        {
            "mount": "right",
            "name": "p1000_single_gen2"
        }
    ],
    "labware": [
        {
            "name": "media tuberack on 1",
            "share": false,
            "slot": "1",
            "type": "opentrons_6_tuberack_falcon_50ml_conical"
        },
        {
            "name": "USA Scientific 96 Deep Well Plate 2.4 mL on 2",
            "share": false,
            "slot": "2",
            "type": "usascientific_96_wellplate_2.4ml_deep"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 200 \u00b5L on 3",
            "share": false,
            "slot": "3",
            "type": "opentrons_96_filtertiprack_200ul"
        },
        {
            "name": "factor tuberack on 4",
            "share": false,
            "slot": "4",
            "type": "opentrons_15_tuberack_falcon_15ml_conical"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 1000 \u00b5L on 6",
            "share": false,
            "slot": "6",
            "type": "opentrons_96_filtertiprack_1000ul"
        },
        {
            "name": "Opentrons Fixed Trash on 12",
            "share": false,
            "slot": "12",
            "type": "opentrons_1_trash_1100ml_fixed"
        }
    ],
    "metadata": {
        "apiLevel": "2.12",
        "author": "Nick <ndiehl@opentrons.com",
        "protocolName": "Cell Culture",
        "source": "Custom Protocol Request"
    },
    "modules": []
}