{
    "content": "\"\"\"End-repair reaction preparation.\"\"\"\nfrom opentrons import protocol_api\nimport math\n\n# The first part of this protocol mixes the DNA samples with end repair\n# buffer and enzyme and ends when the samples are ready for thermal incubation\nmetadata = {\n    'protocolName': '466f93 - Automated LifeCell_NIPT_35Plex_HV',\n    'author': 'Eskil Andersen <eskil.andersen@opentrons.com>',\n    'source': 'Custom Protocol Request',\n    'apiLevel': '2.11'   # CHECK IF YOUR API LEVEL HERE IS UP TO DATE\n                         # IN SECTION 5.2 OF THE APIV2 \"VERSIONING\"\n}\n\n\ndef run(ctx: protocol_api.ProtocolContext):\n    \"\"\"End-repair reaction preparation protocol entry point.\"\"\"\n    [\n     num_samples\n    ] = get_values(  # noqa: F821 (<--- DO NOT REMOVE!)\n        \"num_samples\")\n\n    if not 7 <= num_samples <= 36:\n        raise Exception(\"The number of samples should be between 7 and 36\")\n\n    # define all custom variables above here with descriptions:\n    ER_buffer_I_vol_per_well = 27\n    ER_enz_vol_per_well = 126\n    ER_buffer_per_sample = 1.5\n    ER_enz_vol_per_sample = 0.75\n    mastermix_vol_per_sample = ER_buffer_per_sample + ER_enz_vol_per_sample\n    DNA_sample_transfer_vol = 12.75  # vol of DNA sample for rxn\n    total_rxn_vol = mastermix_vol_per_sample + DNA_sample_transfer_vol\n\n    n_standard_mixes = 10  # Standard number of times to mix a sample (10)\n    # load modules\n\n    '''\n\n    Add your modules here with:\n\n    module_name = ctx.load_module('{module_loadname}', '{slot number}')\n\n    Note: if you are loading a thermocycler, you do not need to specify\n    a slot number - thermocyclers will always occupy slots 7, 8, 10, and 11.\n\n    For all other modules, you can load them on slots 1, 3, 4, 6, 7, 9, 10.\n\n    '''\n\n    # load labware\n\n    '''\n\n    Add your labware here with:\n\n    labware_name = ctx.load_labware('{loadname}', '{slot number}')\n\n    If loading labware on a module, you can load with:\n\n    labware_name = module_name.load_labware('{loadname}')\n    where module_name is defined above.\n\n    '''\n    # 3 custom plates (waiting for specifications) - these will be NEST\n    # I think these can be swapped sequentailly\n    # 96 well PCR plates for now\n    # 1 DNA sample plate\n    # 3? target plates\n    # Reservoir for 80 % ethanol, e.g. a tube rack with a falcon tube\n\n    yourgene_reagent_plate_I \\\n        = ctx.load_labware('biorad_96_wellplate_200ul_pcr', '7',\n                           'Yourgene Reagent plate - 1')\n\n    # DNA sample plate\n    sample_plate = \\\n        ctx.load_labware('biorad_96_wellplate_200ul_pcr',\n                         '4', \"DNA Sample plate\")\n\n    # Destination plate - will be physically changed by the operator through-\n    # out\n    destination_plate = \\\n        ctx.load_labware('biorad_96_wellplate_200ul_pcr',\n                         '1', \"Destination plate 1\")\n\n    # load tipracks\n\n    '''\n\n    Add your tipracks here as a list:\n\n    For a single tip rack:\n\n    tiprack_name = [ctx.load_labware('{loadname}', '{slot number}')]\n\n    For multiple tip racks of the same type:\n\n    tiprack_name = [ctx.load_labware('{loadname}', 'slot')\n                     for slot in ['1', '2', '3']]\n\n    If two different tipracks are on the deck, use convention:\n    tiprack[number of microliters]\n    e.g. tiprack10, tiprack20, tiprack200, tiprack300, tiprack1000\n\n    '''\n    tiprack20s = [ctx.load_labware('opentrons_96_filtertiprack_20ul', slot)\n                  for slot in ['10', '11']]\n    tiprack200s = [ctx.load_labware('opentrons_96_filtertiprack_200ul', slot)\n                   for slot in ['5', '8']]\n\n    # load instrument\n\n    '''\n    Nomenclature for pipette:\n\n    use 'p'  for single-channel, 'm' for multi-channel,\n    followed by number of microliters.\n\n    p20, p300, p1000 (single channel pipettes)\n    m20, m300 (multi-channel pipettes)\n\n    If loading pipette, load with:\n\n    ctx.load_instrument(\n                        '{pipette api load name}',\n                        pipette_mount (\"left\", or \"right\"),\n                        tip_racks=tiprack\n                        )\n    '''\n    # Load left and right pipettes\n    p20 = ctx.load_instrument(\"p20_single_gen2\", \"left\", tip_racks=tiprack20s)\n    p300 = ctx.load_instrument(\"p300_single_gen2\", \"right\",\n                               tip_racks=tiprack200s)\n\n    # pipette functions   # INCLUDE ANY BINDING TO CLASS\n\n    '''\n\n    Define all pipette functions, and class extensions here.\n    These may include but are not limited to:\n\n    - Custom pickup functions\n    - Custom drop tip functions\n    - Custom Tip tracking functions\n    - Custom Trash tracking functions\n    - Slow tip withdrawal\n\n    For any functions in your protocol, describe the function as well as\n    describe the parameters which are to be passed in as a docstring below\n    the function (see below).\n\n    def pick_up(pipette):\n        \"\"\"`pick_up()` will pause the protocol when all tip boxes are out of\n        tips, prompting the user to replace all tip racks. Once tipracks are\n        reset, the protocol will start picking up tips from the first tip\n        box as defined in the slot order when assigning the labware definition\n        for that tip box. `pick_up()` will track tips for both pipettes if\n        applicable.\n\n        :param pipette: The pipette desired to pick up tip\n        as definited earlier in the protocol (e.g. p300, m20).\n        \"\"\"\n        try:\n            pipette.pick_up_tip()\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Replace empty tip racks\")\n            pipette.reset_tipracks()\n            pipette.pick_up_tip()\n\n    '''\n    def drop_all_tips():\n        for pip in [p20, p300]:\n            if pip.has_tip:\n                pip.drop_tip()\n\n    # helper functions\n    '''\n    Define any custom helper functions outside of the pipette scope here, using\n    the convention seen above.\n\n    e.g.\n\n    def remove_supernatant(vol, index):\n        \"\"\"\n        function description\n\n        :param vol:\n\n        :param index:\n        \"\"\"\n\n\n    '''\n\n    # reagents\n\n    '''\n    Define where all reagents are on the deck using the labware defined above.\n\n    e.g.\n\n    water = reservoir12.wells()[-1]\n    waste = reservoir.wells()[0]\n    samples = plate.rows()[0][0]\n    dnase = tuberack.wells_by_name()['A4']\n\n    '''\n\n    # End repair buffer - I is in column one of yourgene_reagent_plate_I\n    # End repair enzyme is in well A2 of the sample plate\n    ER_buffer_I_column = yourgene_reagent_plate_I.columns()[0]\n    ER_enzyme_well = yourgene_reagent_plate_I.wells_by_name()['A2']\n    ER_mastermix_destination = yourgene_reagent_plate_I.wells_by_name()['B2']\n    # plate, tube rack maps\n\n    '''\n    Define any plate or tube maps here.\n\n    e.g.\n\n    plate_wells_by_row = [well for row in plate.rows() for well in row]\n\n    '''\n\n    # protocol\n\n    '''\n\n    Include header sections as follows for each \"section\" of your protocol.\n\n    Section can be defined as a step in a bench protocol.\n\n    e.g.\n\n    ctx.comment('\\n\\nMOVING MASTERMIX TO SAMPLES IN COLUMNS 1-6\\n')\n\n    for .... in ...:\n        ...\n        ...\n\n    ctx.comment('\\n\\nRUNNING THERMOCYCLER PROFILE\\n')\n\n    ...\n    ...\n    ...\n\n\n    '''\n    # PROTOCOL BEGINS HERE\n\n    # Prepare End Repair Mastermix\n    # 1.2.7 - Mix end repair buffer I (column 1, prep plate 1) and End repair\n    # enzyme I (in well pos. A2, prep plate 1) - mix by pipetting 10 times\n    # Create a mastermix of the two\n    # The mastermix will be placed in the unused well B2 of reagent plate I\n    er_buffer_volume = ER_buffer_per_sample * (num_samples+1)\n    er_enzyme_volume = ER_enz_vol_per_sample * (num_samples+1)\n\n    for i in range(0, math.ceil(er_buffer_volume/ER_buffer_I_vol_per_well)):\n        well = ER_buffer_I_column[i]\n        # Mix the buffer 10x\n        vol = (er_buffer_volume if er_buffer_volume\n               < ER_buffer_I_vol_per_well else ER_buffer_I_vol_per_well)\n        pip = p20 if vol < 20 else p300\n        if not pip.has_tip:\n            try:\n                pip.pick_up_tip()\n            except protocol_api.labware.OutOfTipsError:\n                ctx.pause(\"Replace empty tip racks\")\n                pip.reset_tipracks()\n                pip.pick_up_tip()\n        pip.mix(n_standard_mixes, 20, well)\n        pip.transfer(vol, well, ER_mastermix_destination, new_tip='never')\n        er_buffer_volume = er_buffer_volume - vol\n\n    drop_all_tips()\n\n    # Mix the ER enzyme, total volume of enz. 126 \u00b5L,\n    # max volume for mastermix is 0.75 \u00b5L*36=27 \u00b5L\n    try:\n        p300.pick_up_tip()\n    except protocol_api.labware.OutOfTipsError:\n        ctx.pause(\"Replace empty tip racks\")\n        p300.reset_tipracks()\n        p300.pick_up_tip()\n    p300.mix(n_standard_mixes, ER_enz_vol_per_well/2, ER_enzyme_well)\n    p300.drop_tip()\n\n    pip = p20 if er_enzyme_volume <= 20 else p300\n    try:\n        pip.transfer(er_enzyme_volume, ER_enzyme_well,\n                     ER_mastermix_destination)\n    except protocol_api.labware.OutOfTipsError:\n        ctx.pause(\"Replace empty tip racks\")\n        pip.reset_tipracks()\n        pip.transfer(er_enzyme_volume, ER_enzyme_well,\n                     ER_mastermix_destination)\n\n    # 1.2.7 to 1.2.9, page 2\n    # Move 12.75 uL of sample to the destination plate\n    # Add required volume of buffer and enzyme to the sample wells\n    # See Table \"End repair reaction\" on page 2 of the protocol\n    # This will use up one 20 uL tiprack\n    ctx.comment(\"\\nTransferring DNA\")\n    for s, d in zip(sample_plate.wells()[0:num_samples],\n                    destination_plate.wells()[0:num_samples]):\n        try:\n            p20.transfer(DNA_sample_transfer_vol, s, d)\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Replace empty tip racks\")\n            p20.reset_tipracks()\n            p20.transfer(DNA_sample_transfer_vol, s, d)\n\n    # Transfer mastermix to each well and mix each sample ten times\n    ctx.comment(\"\\nTransferring End repair mastermix\")\n    for well in destination_plate.wells()[0:num_samples]:\n        try:\n            p20.pick_up_tip()\n        except protocol_api.labware.OutOfTipsError:\n            ctx.pause(\"Replace empty tip racks\")\n            p20.reset_tipracks()\n            p20.pick_up_tip()\n        p20.aspirate(mastermix_vol_per_sample, ER_mastermix_destination)\n        p20.dispense(mastermix_vol_per_sample, well)\n        # Mix each sample ten (n_standard_mixes) times\n        p20.mix(n_standard_mixes, total_rxn_vol/2)\n        p20.drop_tip()\n\n    ctx.comment(\"\\nPulse spin the destination plate for 5 seconds\")\n    ctx.comment(\"Perform the end repair reaction in the thermocycler\")\n    ctx.comment(\"Remember to thaw (30 minutes) and pulse spin Reagent plate \" +\n                \"3 before inserting it for protocol part 2\")\n    ctx.comment(\"~~~ End of protocol part 1 ~~~~\\n\")\n",
    "custom_labware_defs": [],
    "fields": [
        {
            "default": 36,
            "label": "Number of samples",
            "name": "num_samples",
            "type": "int"
        }
    ],
    "instruments": [
        {
            "mount": "left",
            "name": "p20_single_gen2"
        },
        {
            "mount": "right",
            "name": "p300_single_gen2"
        }
    ],
    "labware": [
        {
            "name": "Destination plate 1 on 1",
            "share": false,
            "slot": "1",
            "type": "biorad_96_wellplate_200ul_pcr"
        },
        {
            "name": "DNA Sample plate on 4",
            "share": false,
            "slot": "4",
            "type": "biorad_96_wellplate_200ul_pcr"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 200 \u00b5L on 5",
            "share": false,
            "slot": "5",
            "type": "opentrons_96_filtertiprack_200ul"
        },
        {
            "name": "Yourgene Reagent plate - 1 on 7",
            "share": false,
            "slot": "7",
            "type": "biorad_96_wellplate_200ul_pcr"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 200 \u00b5L on 8",
            "share": false,
            "slot": "8",
            "type": "opentrons_96_filtertiprack_200ul"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 20 \u00b5L on 10",
            "share": false,
            "slot": "10",
            "type": "opentrons_96_filtertiprack_20ul"
        },
        {
            "name": "Opentrons 96 Filter Tip Rack 20 \u00b5L on 11",
            "share": false,
            "slot": "11",
            "type": "opentrons_96_filtertiprack_20ul"
        },
        {
            "name": "Opentrons Fixed Trash on 12",
            "share": false,
            "slot": "12",
            "type": "opentrons_1_trash_1100ml_fixed"
        }
    ],
    "metadata": {
        "apiLevel": "2.11",
        "author": "Eskil Andersen <eskil.andersen@opentrons.com>",
        "protocolName": "466f93 - Automated LifeCell_NIPT_35Plex_HV",
        "source": "Custom Protocol Request"
    },
    "modules": []
}