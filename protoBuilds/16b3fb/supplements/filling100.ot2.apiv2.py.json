{
    "content": "from opentrons.types import Point\nimport math\n\nmetadata = {\n    'protocolName': 'Custom Bulb Filling - 100ul',\n    'apiLevel': '2.14',\n    'author': 'Nick <ndiehl@opentrons.com>'\n}\n\nvol_bulb = 100\nnum_bulbs = 432\nnum_racks = math.ceil(num_bulbs/48)\nvol_preairgap = 0\n\n\ndef run(ctx):\n\n    buffer = ctx.load_labware('nest_1_reservoir_195ml', '10').wells()[0]\n    tiprack1000 = [ctx.load_labware('opentrons_96_tiprack_1000ul', '11')]\n    bulb_racks = [\n        ctx.load_labware('agfiltration_48_tuberack_150ul', slot,\n                         f'bulb rack {slot}')\n        for slot in range(1, 1+num_racks)]\n\n    p1000 = ctx.load_instrument('p1000_single_gen2', 'right',\n                                tip_racks=tiprack1000)\n\n    def slow_withdraw(pip, well, delay_s=1.0, z=0):\n        pip.default_speed /= 10\n        if delay_s > 0:\n            ctx.delay(seconds=delay_s)\n        pip.move_to(well.top().move(Point(z=z)))\n        pip.default_speed *= 10\n\n    def custom_touch(pip, well, z=-1, modulator=0.9):\n        radius = well.diameter/2 if well.diameter else well.length/2\n        magnitude = radius * modulator\n        pip.move_to(well.top().move(Point(x=magnitude, z=z)))\n\n    bulbs = [well for rack in bulb_racks for well in rack.wells()][:num_bulbs]\n\n    # buffer_liquid = ctx.define_liquid(\n    #     name='buffer',\n    #     description='buffer',\n    #     display_color='#0000FF')\n    # buffer.load_liquid(buffer_liquid, 190000)\n\n    # create distribution sets\n    num_bulbs_per_asp = math.floor(\n        p1000.tip_racks[0].wells()[0].max_volume/(vol_bulb+vol_preairgap))\n    num_distribution_sets = math.ceil(num_bulbs/num_bulbs_per_asp)\n    distribution_sets = [\n        bulbs[i*num_bulbs_per_asp:(i+1)*num_bulbs_per_asp]\n        if i < num_distribution_sets - 1\n        else bulbs[i*num_bulbs_per_asp:]\n        for i in range(num_distribution_sets)]\n\n    p1000.pick_up_tip()\n    for d_set in distribution_sets:\n        p1000.blow_out(buffer.top())\n        if vol_preairgap > 0:\n            for _ in range(len(d_set)):\n                p1000.aspirate(vol_preairgap, buffer.top())\n                p1000.aspirate(vol_bulb, buffer.bottom(2))\n                slow_withdraw(p1000, buffer)\n        else:\n            p1000.aspirate(vol_bulb*len(d_set), buffer.bottom(2))\n            slow_withdraw(p1000, buffer)\n        for d in d_set:\n            p1000.dispense(vol_bulb+vol_preairgap, d.top(-1))\n            custom_touch(p1000, d)\n    p1000.drop_tip()\n",
    "custom_labware_defs": [],
    "fields": [],
    "instruments": [
        {
            "mount": "right",
            "name": "p1000_single_gen2"
        }
    ],
    "labware": [
        {
            "name": "bulb rack 1 on 1",
            "share": false,
            "slot": "1",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 2 on 2",
            "share": false,
            "slot": "2",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 3 on 3",
            "share": false,
            "slot": "3",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 4 on 4",
            "share": false,
            "slot": "4",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 5 on 5",
            "share": false,
            "slot": "5",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 6 on 6",
            "share": false,
            "slot": "6",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 7 on 7",
            "share": false,
            "slot": "7",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 8 on 8",
            "share": false,
            "slot": "8",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "bulb rack 9 on 9",
            "share": false,
            "slot": "9",
            "type": "agfiltration_48_tuberack_150ul"
        },
        {
            "name": "NEST 1 Well Reservoir 195 mL on 10",
            "share": false,
            "slot": "10",
            "type": "nest_1_reservoir_195ml"
        },
        {
            "name": "Opentrons 96 Tip Rack 1000 \u00b5L on 11",
            "share": false,
            "slot": "11",
            "type": "opentrons_96_tiprack_1000ul"
        },
        {
            "name": "Opentrons Fixed Trash on 12",
            "share": false,
            "slot": "12",
            "type": "opentrons_1_trash_1100ml_fixed"
        }
    ],
    "metadata": {
        "apiLevel": "2.14",
        "author": "Nick <ndiehl@opentrons.com>",
        "protocolName": "Custom Bulb Filling - 100ul"
    },
    "modules": []
}